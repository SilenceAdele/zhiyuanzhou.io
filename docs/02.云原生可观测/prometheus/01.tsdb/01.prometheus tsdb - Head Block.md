---
date: 2025-11-14 00:07:51
title: prometheus tsdb - Head Block
categories:
  - äº‘åŸç”Ÿå¯è§‚æµ‹
tags:
  - prometheus
  - tsdb
coverImg: https://image.zhiyuanzhou.online/defalutPostBgi.jpg
permalink: /observability/szutn
---
## ä¸€ã€æ¦‚è¿°

prometheus v2.0å¼•å…¥äº†tsdbï¼Œä»¥ä¸‹æ˜¯tsdbçš„å…¨å±€æ¨¡å‹ä»‹ç»ï¼š

![1763051529947](https://cdn.jsdelivr.net/gh/SilenceAdele/zhiyuanzhou.io@master/docs/02.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B/prometheus/01.tsdb/image/01.prometheustsdb-HeadBlock/1763051529947.png){width=1000 height=200}

---

### ğŸ§  å†…å­˜éƒ¨åˆ†ï¼šHead Block

* Head block æ˜¯æ•°æ®åº“ä¸­çš„å†…å­˜éƒ¨åˆ†ï¼Œç”¨äºå­˜å‚¨æœ€æ–°å†™å…¥çš„æ•°æ®ã€‚
* æ¯ä¸ªæ–°å†™å…¥çš„æ ·æœ¬ï¼ˆç²‰è‰²æ¡†ï¼‰ï¼Œé¦–å…ˆä¼šè¿›å…¥ Head blockï¼ˆå³åœ¨å†…å­˜ä¸­æš‚å­˜ï¼‰ã€‚
* è¿™æ˜¯æ•°æ®è¿›å…¥ç³»ç»Ÿçš„ç¬¬ä¸€ç«™ã€‚

---

### ğŸ§¾ WALï¼ˆWrite-Ahead Logï¼‰

* WAL ç”¨äºæŒä¹…åŒ–å†™å…¥æ—¥å¿—ï¼Œç¡®ä¿å³ä½¿æœåŠ¡å´©æºƒä¹Ÿèƒ½æ¢å¤æ•°æ®ã€‚
* æ¯ä¸ªæ ·æœ¬åœ¨å†™å…¥å†…å­˜çš„åŒæ—¶ä¹Ÿä¼šå†™å…¥ WALã€‚
* WAL çš„å­˜åœ¨è®©å†™å…¥æ“ä½œå…·å¤‡â€œå…ˆå†™æ—¥å¿—ï¼Œå†æ›´æ–°å†…å­˜â€çš„å®‰å…¨æ€§ã€‚

---

### ğŸ“¦ ç£ç›˜éƒ¨åˆ†ï¼šç°è‰²å—å’Œè“è‰²å—

* å†…å­˜ä¸­çš„æ•°æ®åœ¨ä¸€æ®µæ—¶é—´åä¼šè¢«

åˆ·æ–°ï¼ˆflushï¼‰åˆ°ç£ç›˜ï¼Œå½¢æˆç°è‰²çš„æŒä¹…åŒ–å—ï¼ˆimmutable blocksï¼‰ã€‚

* åˆ·æ–°è¿‡ç¨‹ä¸­ä¼šå…ˆç”Ÿæˆ

Memory-Mapped Chunksï¼ˆè“è‰²å—ï¼‰ï¼Œå³å†…å­˜æ˜ å°„çš„ä¸­é—´çŠ¶æ€ã€‚

---

### ğŸ” å—çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

* å½“è“è‰²å—æˆ–å†…å­˜å—å˜â€œè€â€æ—¶ï¼Œä¼šè¢«è¿›ä¸€æ­¥åˆ·æ–°ä¸ºç£ç›˜ä¸Šçš„æŒä¹…å—ã€‚
* è¿™äº›ç£ç›˜å—æ˜¯ä¸å¯å˜çš„ï¼ˆimmutableï¼‰ï¼Œä¸ä¼šå†è¢«æ›´æ”¹ã€‚
* å¤šä¸ªæ—§å—ä¼šè¢«åˆå¹¶ï¼ˆmergeï¼‰ï¼Œä¼˜åŒ–å­˜å‚¨ç»“æ„ã€‚
* æœ€ç»ˆï¼Œå½“è¿™äº›å—è¶…è¿‡è®¾å®šçš„ä¿ç•™æœŸï¼ˆretention periodï¼‰ï¼Œå°±ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚

---

### âœ… æ€»ç»“æµç¨‹

1. æ ·æœ¬å‡†å¤‡å†™å…¥ â†’ å†…å­˜ Head block
2. å…ˆå†™å…¥ WAL æ—¥å¿—ï¼Œä¿è¯æŒä¹…æ€§
3. å†å†™å…¥Head block
4. ä¸€æ®µæ—¶é—´åï¼Œflush ä¸º memory-mapped chunksï¼ˆè“è‰²ï¼‰
5. å†è½¬åŒ–ä¸ºç£ç›˜æŒä¹…å—ï¼ˆç°è‰²ï¼‰
6. å¤šä¸ªå—åˆå¹¶å‹ç¼©
7. åˆ°æœŸååˆ é™¤

## äºŒã€Head block æ ·æœ¬å¯¿å‘½

ä»¥å•ä¸ªæ—¶é—´åºåˆ—ä¸ºä¾‹ï¼Œé€‚ç”¨äºæ‰€æœ‰åºåˆ—ã€‚

![1763051562226](https://cdn.jsdelivr.net/gh/SilenceAdele/zhiyuanzhou.io@master/docs/02.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B/prometheus/01.tsdb/image/01.prometheustsdb-HeadBlock/1763051562226.png){width=1000 height=200}

æ ·æœ¬å­˜å‚¨åœ¨ç§°ä¸ºâ€œchunkâ€çš„å‹ç¼©å•å…ƒä¸­ã€‚æ ·æœ¬ä¼ å…¥æ—¶ï¼Œä¼šè¢«æå–åˆ°â€œactive chunkâ€ï¼ˆçº¢è‰²å—ï¼‰ä¸­ã€‚è¿™æ˜¯å”¯ä¸€å¯ä»¥ä¸»åŠ¨å†™å…¥æ•°æ®çš„å•å…ƒã€‚

åœ¨å°†æ ·æœ¬æäº¤åˆ°chunkä¸­æ—¶ï¼Œæˆ‘ä»¬è¿˜ä¼šå°†å…¶è®°å½•åœ¨ç£ç›˜ï¼ˆæ£•è‰²å—ï¼‰ä¸Šçš„é¢„å†™æ—¥å¿—ï¼ˆWrite-Ahead-Log ï¼Œç®€ç§°WAL) ä¸­ï¼Œä»¥å®ç°æŒä¹…æ€§ï¼ˆè¿™æ„å‘³ç€å³ä½¿æœºå™¨çªç„¶å´©æºƒï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»ä¸­æ¢å¤å†…å­˜ä¸­çš„æ•°æ®ï¼‰ã€‚

![1763051674580](https://cdn.jsdelivr.net/gh/SilenceAdele/zhiyuanzhou.io@master/docs/02.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B/prometheus/01.tsdb/image/01.prometheustsdb-HeadBlock/1763051674580.png){width=1000 height=200}

ä¸€æ—¦ä¸€ä¸ªå—ï¼ˆchunkï¼‰å¡«æ»¡äº† 120 ä¸ªæ ·æœ¬ï¼Œæˆ–è€…è·¨è¶Šäº† chunk/block èŒƒå›´ï¼ˆè¿™é‡Œæˆ‘ä»¬ç§°ä¹‹ä¸º chunkRangeï¼Œé»˜è®¤æ˜¯ 2 å°æ—¶ï¼‰ï¼Œå°±ä¼šåˆ‡å‰²å‡ºä¸€ä¸ªæ–°çš„å—ï¼Œè€Œæ—§çš„å—å°±è¢«è®¤ä¸ºæ˜¯â€œå·²æ»¡â€çš„ã€‚

åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æŠ“å–é—´éš”ï¼ˆscrape intervalï¼‰æ˜¯ 15 ç§’ï¼Œå› æ­¤ 120 ä¸ªæ ·æœ¬ï¼ˆä¸€ä¸ªå®Œæ•´çš„å—ï¼‰å¤§çº¦ä¼šè¦†ç›– 30 åˆ†é’Ÿã€‚

å¸¦æœ‰æ•°å­— 1 çš„é»„è‰²å—è¡¨ç¤ºåˆšåˆšå¡«æ»¡çš„å®Œæ•´å—ï¼Œè€Œçº¢è‰²çš„å—è¡¨ç¤ºæ–°åˆ›å»ºçš„å—ã€‚

![1763051734225](https://cdn.jsdelivr.net/gh/SilenceAdele/zhiyuanzhou.io@master/docs/02.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B/prometheus/01.tsdb/image/01.prometheustsdb-HeadBlock/1763051734225.png){width=1000 height=200}

ä» Prometheus v2.19.0 å¼€å§‹ï¼Œæˆ‘ä»¬ä¸å†æŠŠæ‰€æœ‰çš„å—ï¼ˆchunkï¼‰éƒ½å­˜æ”¾åœ¨å†…å­˜ä¸­ã€‚

ä¸€æ—¦åˆ‡å‰²å‡ºä¸€ä¸ªæ–°å—ï¼Œå·²æ»¡çš„å—å°±ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼Œå¹¶é€šè¿‡å†…å­˜æ˜ å°„ï¼ˆmemory-mappingï¼‰çš„æ–¹å¼ä»ç£ç›˜åŠ è½½ï¼ŒåŒæ—¶åœ¨å†…å­˜ä¸­åªä¿å­˜ä¸€ä¸ªå¼•ç”¨ã€‚

å€ŸåŠ©å†…å­˜æ˜ å°„ï¼Œæˆ‘ä»¬åœ¨éœ€è¦æ—¶å¯ä»¥é€šè¿‡è¿™ä¸ªå¼•ç”¨ï¼ŒæŠŠå—åŠ¨æ€åœ°åŠ è½½åˆ°å†…å­˜ä¸­ï¼›è¿™æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§åŠŸèƒ½ã€‚

![1763051755736](https://cdn.jsdelivr.net/gh/SilenceAdele/zhiyuanzhou.io@master/docs/02.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B/prometheus/01.tsdb/image/01.prometheustsdb-HeadBlock/1763051755736.png){width=1000 height=200}

åŒæ ·åœ°ï¼Œéšç€æ–°çš„æ ·æœ¬ä¸æ–­åˆ°æ¥ï¼Œå°±ä¼šä¸æ–­åˆ‡å‰²å‡ºæ–°çš„å—ï¼ˆchunkï¼‰ã€‚

![1763051770953](https://cdn.jsdelivr.net/gh/SilenceAdele/zhiyuanzhou.io@master/docs/02.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B/prometheus/01.tsdb/image/01.prometheustsdb-HeadBlock/1763051770953.png){width=1000 height=200}

å®ƒä»¬ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼Œå¹¶é€šè¿‡å†…å­˜æ˜ å°„çš„æ–¹å¼è¿›è¡ŒåŠ è½½ã€‚

![1763051785870](https://cdn.jsdelivr.net/gh/SilenceAdele/zhiyuanzhou.io@master/docs/02.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B/prometheus/01.tsdb/image/01.prometheustsdb-HeadBlock/1763051785870.png){width=1000 height=200}

ä¸€æ®µæ—¶é—´åï¼ŒHead å—ä¼šåƒä¸Šå›¾é‚£æ ·ã€‚å‡è®¾çº¢è‰²çš„å—å·²ç»å¿«è¦å¡«æ»¡ï¼Œé‚£ä¹ˆæ­¤æ—¶ Head ä¸­å°±æœ‰ 3 å°æ—¶çš„æ•°æ®ï¼ˆ6 ä¸ªå—ï¼Œæ¯ä¸ªå—è·¨åº¦ä¸º 30 åˆ†é’Ÿï¼‰ã€‚è¿™ç›¸å½“äº **chunkRange Ã— 3/2**ã€‚

![1763051800905](https://cdn.jsdelivr.net/gh/SilenceAdele/zhiyuanzhou.io@master/docs/02.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B/prometheus/01.tsdb/image/01.prometheustsdb-HeadBlock/1763051800905.png){width=1000 height=200}

![1763051811858](https://cdn.jsdelivr.net/gh/SilenceAdele/zhiyuanzhou.io@master/docs/02.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B/prometheus/01.tsdb/image/01.prometheustsdb-HeadBlock/1763051811858.png){width=1000 height=200}å½“ Head ä¸­çš„æ•°æ®è·¨åº¦è¾¾åˆ° **chunkRange Ã— 3/2** æ—¶ï¼Œæœ€æ—©çš„ä¸€ä¸ª chunkRange çš„æ•°æ®ï¼ˆè¿™é‡Œæ˜¯ 2 å°æ—¶ï¼‰ä¼šè¢«å‹ç¼©ï¼ˆcompactedï¼‰æˆä¸€ä¸ªæŒä¹…åŒ–å—ï¼ˆpersistent blockï¼‰ã€‚å¦‚æœä½ æ³¨æ„åˆ°ä¸Šæ–‡ï¼Œè¿™ä¸ªæ—¶å€™ WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰ä¼šè¢«æˆªæ–­ï¼ˆtruncateï¼‰ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªâ€œæ£€æŸ¥ç‚¹â€ï¼ˆcheckpointï¼‰ï¼ˆå›¾ä¸­æœªå±•ç¤ºï¼‰ã€‚æˆ‘ä¼šåœ¨åç»­çš„åšå®¢ä¸­è¯¦ç»†ä»‹ç» **checkpointã€WAL æˆªæ–­ã€å‹ç¼©ã€æŒä¹…åŒ–å—ä»¥åŠå®ƒçš„ç´¢å¼•**ã€‚

è¿™ç§æ•°æ®çš„æ‘„å–ï¼ˆingestionï¼‰ã€å†…å­˜æ˜ å°„ã€å‹ç¼©å½¢æˆæŒä¹…åŒ–å—çš„å¾ªç¯ä¼šä¸æ–­è¿›è¡Œã€‚è€Œè¿™æ­£æ˜¯ Head å— çš„åŸºæœ¬åŠŸèƒ½ã€‚

**å‚è€ƒæ–‡çŒ®ï¼š**

https://ganeshvernekar.com/blog/prometheus-tsdb-the-head-block/